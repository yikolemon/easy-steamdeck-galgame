name: Build GUI Executable for SteamDeck

on:
  push:
    tags:
      - 'v*'
    branches:
      - master
  workflow_dispatch:

jobs:
  build-pyinstaller:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build-type: [debug, release]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            python3-dev \
            python3-tk \
            libx11-dev \
            libxext-dev \
            libxft-dev \
            libxss-dev
            
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Build with PyInstaller (${{ matrix.build-type }})
        env:
          BUILD_TYPE: ${{ matrix.build-type }}
        run: |
          pyinstaller --clean steamdeck_galgame.spec
            
      - name: Verify executable (${{ matrix.build-type }})
        run: |
          EXECUTABLE="dist/steamdeck-galgame-${{ matrix.build-type }}"
          if [ -f "$EXECUTABLE" ]; then
            ls -lh "$EXECUTABLE"
            file "$EXECUTABLE"
          else
            echo "Executable not found at: $EXECUTABLE"
            ls -lh dist/
            exit 1
          fi
      
      - name: Create release package (${{ matrix.build-type }})
        run: |
          PACKAGE_NAME="steamdeck-galgame-${{ matrix.build-type }}"
          EXECUTABLE="dist/${PACKAGE_NAME}"
          PACKAGE_DIR="dist/${PACKAGE_NAME}-pkg"
          
          mv "${EXECUTABLE}" "dist/steamdeck-galgame-temp"
          mkdir -p "${PACKAGE_DIR}"
          mv "dist/steamdeck-galgame-temp" "${PACKAGE_DIR}/steamdeck-galgame"
          
          cp install_desktop.sh "${PACKAGE_DIR}/"
          cp uninstall.sh "${PACKAGE_DIR}/"
          cp steamdeck-galgame.desktop "${PACKAGE_DIR}/"
          
          cat > "${PACKAGE_DIR}/README.txt" << 'READMEEOF'
          SteamDeck Galgame - Chinese Game Environment Tool
          ==================================================
          
          Quick Start:
          1. Extract to any directory
          2. Run install script: ./install_desktop.sh
          3. Launch from application menu
          
          Or run directly: ./steamdeck-galgame
          
          Uninstall:
          - Remove shortcut only: ./uninstall.sh
          - Remove all files: ./uninstall.sh --all
          
          Files:
          - steamdeck-galgame: Main program
          - install_desktop.sh: Install desktop shortcut
          - uninstall.sh: Uninstall script
          
          More info: https://github.com/yikolemon/steamdeck-galgame
          READMEEOF
          
          chmod +x "${PACKAGE_DIR}/steamdeck-galgame"
          chmod +x "${PACKAGE_DIR}/install_desktop.sh"
          chmod +x "${PACKAGE_DIR}/uninstall.sh"
          
          mv "${PACKAGE_DIR}" "dist/${PACKAGE_NAME}"
          
          echo "Package contents:"
          ls -lh "dist/${PACKAGE_NAME}/"
          
      - name: Create tarball (${{ matrix.build-type }})
        run: |
          cd dist
          PACKAGE_NAME="steamdeck-galgame-${{ matrix.build-type }}"
          tar -czf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}"
          ls -lh "${PACKAGE_NAME}.tar.gz"
          
      - name: Upload artifacts (${{ matrix.build-type }})
        uses: actions/upload-artifact@v4
        with:
          name: pyinstaller-${{ matrix.build-type }}
          path: |
            dist/steamdeck-galgame-${{ matrix.build-type }}/
            dist/steamdeck-galgame-${{ matrix.build-type }}.tar.gz
          retention-days: 30
  
  create-release:
    needs: build-pyinstaller
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find all-artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
          ls -lh release-assets/
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-assets/steamdeck-galgame-debug.tar.gz
            release-assets/steamdeck-galgame-release.tar.gz
          body: |
            ## SteamDeck Galgame Config Tool (GUI Version)
            
            Ready-to-use Chinese game environment configuration tool for SteamDeck!
            
            ### Download
            
            | Version | Description |
            |---------|-------------|
            | `steamdeck-galgame-release.tar.gz` | **Recommended** - Daily use |
            | `steamdeck-galgame-debug.tar.gz` | Debug version for troubleshooting |
            
            ### Installation
            
            ```bash
            # 1. Extract
            tar -xzf steamdeck-galgame-release.tar.gz
            cd steamdeck-galgame-release
            
            # 2. Install desktop shortcut (optional)
            ./install_desktop.sh
            
            # 3. Launch from menu or run directly
            ./steamdeck-galgame
            ```
            
            ### Uninstall
            
            ```bash
            # Remove shortcut only
            ./uninstall.sh
            
            # Remove all files
            ./uninstall.sh --all
            ```
            
            ### Package Contents
            
            ```
            steamdeck-galgame-release/
            ├── steamdeck-galgame         # Main program
            ├── install_desktop.sh        # Install shortcut
            ├── uninstall.sh              # Uninstall script
            ├── steamdeck-galgame.desktop # Desktop file
            └── README.txt                # Documentation
            ```
            
            ### Features
            
            - [x] No Python required
            - [x] All dependencies bundled
            - [x] GUI interface (CustomTkinter)
            - [x] One-click Chinese/Japanese locale install
            - [x] One-click font installation
            - [x] Steam game launch options management
            - [x] Desktop integration support
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
