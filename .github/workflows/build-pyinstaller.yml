name: Build GUI Executable for SteamDeck

on:
  push:
    tags:
      - 'v*'
    branches:
      - master
  workflow_dispatch:

jobs:
  build-pyinstaller:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build-type: [debug, release]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            python3-dev \
            python3-tk \
            libx11-dev \
            libxext-dev \
            libxft-dev \
            libxss-dev
            
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Build with PyInstaller (${{ matrix.build-type }})
        env:
          BUILD_TYPE: ${{ matrix.build-type }}
        run: |
          pyinstaller --clean steamdeck_galgame.spec
            
      - name: Verify executable (${{ matrix.build-type }})
        run: |
          EXECUTABLE="dist/steamdeck-galgame-${{ matrix.build-type }}"
          if [ -f "$EXECUTABLE" ]; then
            ls -lh "$EXECUTABLE"
            file "$EXECUTABLE"
          else
            echo "Executable not found at: $EXECUTABLE"
            ls -lh dist/
            exit 1
          fi
      
      - name: Create release package (${{ matrix.build-type }})
        run: |
          # Define names
          PACKAGE_NAME="steamdeck-galgame-${{ matrix.build-type }}"
          EXECUTABLE="dist/${PACKAGE_NAME}"
          PACKAGE_DIR="dist/${PACKAGE_NAME}-pkg"
          
          # First rename executable to temp location
          mv "${EXECUTABLE}" "dist/steamdeck-galgame-temp"
          
          # Create package directory
          mkdir -p "${PACKAGE_DIR}"
          
          # Move executable into package directory with final name
          mv "dist/steamdeck-galgame-temp" "${PACKAGE_DIR}/steamdeck-galgame"
          
          # Copy installation scripts and desktop file
          cp install_desktop.sh "${PACKAGE_DIR}/"
          cp steamdeck-galgame.desktop "${PACKAGE_DIR}/"
          
          # Create README for the package
          cat > "${PACKAGE_DIR}/README.txt" << 'READMEEOF'
          SteamDeck Galgame - 中文游戏环境配置工具
          ==========================================
          
          快速开始:
          ---------
          1. 解压到任意目录
          2. 运行安装脚本创建桌面快捷方式:
             chmod +x install_desktop.sh
             ./install_desktop.sh
          
          3. 从应用菜单启动 "SteamDeck Galgame" 或 "中文游戏助手"
          
          或者直接运行:
          -------------
          chmod +x steamdeck-galgame
          ./steamdeck-galgame
          
          文件说明:
          ---------
          - steamdeck-galgame       : 主程序
          - install_desktop.sh      : 桌面快捷方式安装脚本
          - steamdeck-galgame.desktop : 桌面快捷方式模板
          
          更多信息请访问: https://github.com/yikolemon/steamdeck-galgame
          READMEEOF
          
          # Make scripts executable
          chmod +x "${PACKAGE_DIR}/steamdeck-galgame"
          chmod +x "${PACKAGE_DIR}/install_desktop.sh"
          
          # Rename package directory to final name
          mv "${PACKAGE_DIR}" "dist/${PACKAGE_NAME}"
          
          # List package contents
          echo "Package contents:"
          ls -lh "dist/${PACKAGE_NAME}/"
          
      - name: Create tarball (${{ matrix.build-type }})
        run: |
          cd dist
          PACKAGE_NAME="steamdeck-galgame-${{ matrix.build-type }}"
          tar -czf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}"
          ls -lh "${PACKAGE_NAME}.tar.gz"
          
      - name: Upload artifacts (${{ matrix.build-type }})
        uses: actions/upload-artifact@v4
        with:
          name: pyinstaller-${{ matrix.build-type }}
          path: |
            dist/steamdeck-galgame-${{ matrix.build-type }}/
            dist/steamdeck-galgame-${{ matrix.build-type }}.tar.gz
          retention-days: 30
  
  create-release:
    needs: build-pyinstaller
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find all-artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
          ls -lh release-assets/
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-assets/steamdeck-galgame-debug.tar.gz
            release-assets/steamdeck-galgame-release.tar.gz
          body: |
            ## SteamDeck Galgame Config Tool (GUI Version)
            
            开箱即用的 SteamDeck 中文游戏环境配置工具！
            
            ### 下载说明
            
            | 版本 | 说明 |
            |------|------|
            | `steamdeck-galgame-release.tar.gz` | **推荐** - 日常使用版本 |
            | `steamdeck-galgame-debug.tar.gz` | 调试版本，用于问题排查 |
            
            ### 安装步骤
            
            ```bash
            # 1. 解压到任意目录
            tar -xzf steamdeck-galgame-release.tar.gz
            cd steamdeck-galgame-release
            
            # 2. 安装桌面快捷方式（可选，推荐）
            ./install_desktop.sh
            
            # 3. 从应用菜单启动，或直接运行：
            ./steamdeck-galgame
            ```
            
            ### 包内容
            
            ```
            steamdeck-galgame-release/
            ├── steamdeck-galgame        # 主程序
            ├── install_desktop.sh       # 桌面快捷方式安装脚本
            ├── steamdeck-galgame.desktop # 桌面快捷方式模板
            └── README.txt               # 说明文档
            ```
            
            ### 功能特性
            
            - [x] 无需安装 Python
            - [x] 所有依赖已打包
            - [x] 图形界面 (CustomTkinter)
            - [x] 一键安装中文/日文语言环境
            - [x] 一键安装中文字体
            - [x] Steam 游戏启动参数管理
            - [x] 支持添加到应用菜单
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
