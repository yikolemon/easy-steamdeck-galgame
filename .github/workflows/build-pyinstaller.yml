name: Build PyInstaller Executable for SteamDeck

on:
  push:
    tags:
      - 'v*'
    branches:
      - master
  workflow_dispatch:

jobs:
  build-pyinstaller:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build-type: [debug, release]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            python3-dev \
            libx11-dev \
            libxext-dev
            
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Build with PyInstaller (${{ matrix.build-type }})
        env:
          BUILD_TYPE: ${{ matrix.build-type }}
        run: |
          pyinstaller --clean steamdeck_galgame.spec
            
      - name: Verify executable (${{ matrix.build-type }})
        run: |
          # Output is directly in dist/steamdeck-galgame-{type}
          EXECUTABLE="dist/steamdeck-galgame-${{ matrix.build-type }}"
          if [ -f "$EXECUTABLE" ]; then
            ls -lh "$EXECUTABLE"
            file "$EXECUTABLE"
          else
            echo "‚ùå Executable not found at: $EXECUTABLE"
            ls -lh dist/
            exit 1
          fi
          
      - name: Create tarball (${{ matrix.build-type }})
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd dist
          tar -czf steamdeck-galgame-${{ matrix.build-type }}.tar.gz steamdeck-galgame-${{ matrix.build-type }}
          ls -lh steamdeck-galgame-${{ matrix.build-type }}*
          
      - name: Upload artifacts (${{ matrix.build-type }})
        uses: actions/upload-artifact@v4
        with:
          name: pyinstaller-${{ matrix.build-type }}
          path: |
            dist/steamdeck-galgame-${{ matrix.build-type }}
            dist/steamdeck-galgame-${{ matrix.build-type }}.tar.gz
          retention-days: 30
  
  create-release:
    needs: build-pyinstaller
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          # Copy debug build
          cp all-artifacts/pyinstaller-debug/* release-assets/ || true
          # Copy release build  
          cp all-artifacts/pyinstaller-release/* release-assets/ || true
          ls -lh release-assets/
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-assets/steamdeck-galgame-debug
            release-assets/steamdeck-galgame-release
            release-assets/steamdeck-galgame-debug.tar.gz
            release-assets/steamdeck-galgame-release.tar.gz
          body: |
            ## PyInstaller Executables for SteamDeck
            
            This release includes standalone executables that require NO Python installation!
            
            ### üü¢ Release Version (steamdeck-galgame-release)
            - Production-ready executable
            - Minimal logging (INFO level)
            - Optimized for performance
            - Recommended for daily use
            
            ### üîµ Debug Version (steamdeck-galgame-debug)
            - Development/troubleshooting build
            - All debug logs enabled
            - Shows detailed execution information
            - Use when reporting issues or debugging
            
            ### Usage:
            ```bash
            # Download either version
            # Release (recommended):
            chmod +x steamdeck-galgame-release
            ./steamdeck-galgame-release
            
            # Debug (for troubleshooting):
            chmod +x steamdeck-galgame-debug
            ./steamdeck-galgame-debug
            ```
            
            ### Features:
            - [x] No Python required
            - [x] No pip required
            - [x] All dependencies bundled
            - [x] Ready to use on SteamDeck
            - [x] Debug and Release variants
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
