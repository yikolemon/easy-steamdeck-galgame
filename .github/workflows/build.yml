name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - master
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            python3-dev \
            python3-venv \
            libfuse2 \
            wget \
            file \
            desktop-file-utils \
            appstream \
            squashfs-tools
            
      - name: Download appimagetool
        run: |
          mkdir -p ~/tools
          cd ~/tools
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ./appimagetool-x86_64.AppImage --version
          echo "APPIMAGETOOL=$PWD/appimagetool-x86_64.AppImage" >> $GITHUB_ENV
          
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Test imports
        run: |
          python test_import.py
          
      - name: Check packaging readiness
        run: |
          bash check_packaging.sh
          
      - name: Build AppImage
        run: |
          bash build_linux_package.sh
        env:
          APPIMAGETOOL: ${{ env.APPIMAGETOOL }}
          
      - name: List generated files
        run: |
          echo "=== Build Output ==="
          ls -lh dist/ 2>/dev/null || echo "dist/ not found"
          echo "=== All AppImage/tar.gz files ==="
          find . -maxdepth 2 \( -name "*.AppImage" -o -name "*.tar.gz" \) -exec ls -lh {} \;
          
      - name: Generate release notes
        if: startsWith(github.ref, 'refs/tags/')
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          cat > RELEASE_NOTES.md << 'EOF'
          # SteamDeck Galgame v${VERSION} Release
          
          ## ðŸ“¦ åŒ…å«å†…å®¹
          
          - **AppImage**: å•æ–‡ä»¶å¯æ‰§è¡Œï¼Œæ— éœ€å®‰è£…ä¾èµ–
          - **tar.gz**: æºä»£ç åŽ‹ç¼©åŒ…
          
          ## ðŸš€ å®‰è£…æ–¹å¼
          
          ### æ–¹å¼ 1: ä½¿ç”¨ AppImageï¼ˆæŽ¨è SteamDeckï¼‰
          
          1. ä¸‹è½½ `.AppImage` æ–‡ä»¶
          2. ç»™äºˆæ‰§è¡Œæƒé™: `chmod +x steamdeck-galgame-*.AppImage`
          3. è¿è¡Œ: `./steamdeck-galgame-*.AppImage`
          
          ### æ–¹å¼ 2: ä½¿ç”¨æºä»£ç 
          
          1. è§£åŽ‹ `.tar.gz` æ–‡ä»¶
          2. è¿›å…¥ç›®å½•: `cd steamdeck-galgame-*`
          3. å®‰è£…ä¾èµ–: `pip install -r requirements.txt`
          4. è¿è¡Œ TUI: `python3 run.py`
          5. è¿è¡Œ GUI: `python3 run.py --gui`
          
          ## ðŸŽ¯ ä¸»è¦åŠŸèƒ½
          
          - ðŸŒ ä¸­æ–‡ Locale å®‰è£…
          - ðŸ”¤ ä¸­æ–‡å­—ä½“å®‰è£…
          - ðŸŽ® æ¸¸æˆå¯åŠ¨é…ç½®
          - ðŸ’» å®Œæ•´ TUI å’Œ GUI ç•Œé¢
          
          ## ðŸ“ æ›´æ–°æ—¥å¿—
          
          æŸ¥çœ‹ [NEXT_STEPS.md](NEXT_STEPS.md) å’Œ [PROJECT_STATUS.md](PROJECT_STATUS.md) äº†è§£è¯¦æƒ…ã€‚
          EOF
          
          sed -i "s/\${VERSION}/${VERSION}/g" RELEASE_NOTES.md
          cat RELEASE_NOTES.md
          
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/steamdeck-galgame-*-x86_64.AppImage
            dist/steamdeck-galgame-*.tar.gz
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Comment on push
        if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
        run: |
          echo "âœ… Build completed on push to master"
          echo "AppImage: dist/steamdeck-galgame-*-x86_64.AppImage"
          echo "tar.gz: dist/steamdeck-galgame-*.tar.gz"
          
      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: build-output
          path: |
            dist/
            RELEASE_NOTES.md
          retention-days: 30
          if-no-files-found: ignore
