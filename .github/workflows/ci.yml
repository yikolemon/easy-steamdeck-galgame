name: Python Syntax Check & Lint

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Check Python syntax
        run: python -m py_compile main.py utils.py locale_installer.py font_installer.py game_launcher.py

      - name: Verify imports
        run: python -c "import ast; [ast.parse(open(f).read()) for f in ['main.py', 'utils.py', 'locale_installer.py', 'font_installer.py', 'game_launcher.py']]"

      - name: Check JSON manifest
        run: python -m json.tool io.github.steamdeck_galgame.json > /dev/null && echo "âœ… Manifest JSON valid"

  manifest-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate Flatpak manifest
        run: |
          python3 << 'PYEOF'
          import json
          with open('io.github.steamdeck_galgame.json') as f:
              manifest = json.load(f)
              required = ['app-id', 'runtime', 'runtime-version', 'sdk', 'command', 'modules']
              for key in required:
                  if key not in manifest:
                      print(f'Missing required key: {key}')
                      exit(1)
              print('Manifest structure valid')
          PYEOF

      - name: Verify app-id
        run: |
          python3 << 'PYEOF'
          import json
          with open('io.github.steamdeck_galgame.json') as f:
              manifest = json.load(f)
              app_id = manifest.get('app-id')
              if app_id != 'io.github.steamdeck_galgame':
                  print(f'App ID mismatch: {app_id}')
                  exit(1)
              print(f'App ID correct: {app_id}')
          PYEOF

  documentation-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check required documentation
        run: test -f README.md && test -f INSTALL.md && echo "Documentation files found"

  security-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          if grep -r "password" --include="*.py" . 2>/dev/null || true; then
            echo "Note: Review for secrets"
          fi
          echo "Security scan complete"

  build-summary:
    runs-on: ubuntu-latest
    needs:
      - lint
      - manifest-check
      - documentation-check
      - security-check
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Print summary
        run: echo "CI pipeline completed successfully"
