name: Flatpak Build

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:
  build-flatpak:
    runs-on: ubuntu-latest
    container:
      image: bitnami/flatpak-builder:latest
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            python3 \
            python3-pip \
            flatpak \
            flatpak-builder \
            git \
            build-essential

      - name: Set up Flatpak repositories
        run: |
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Validate manifest
        run: |
          python3 << 'PYEOF'
          import json
          import sys
          
          try:
              with open('io.github.steamdeck_galgame.json') as f:
                  manifest = json.load(f)
              
              # Check required fields
              required = ['app-id', 'runtime', 'runtime-version', 'sdk', 'command', 'modules']
              for key in required:
                  if key not in manifest:
                      print(f'âŒ Missing required key: {key}')
                      sys.exit(1)
              
              print('âœ… Manifest structure valid')
              print(f"   App ID: {manifest['app-id']}")
              print(f"   Runtime: {manifest['runtime']} {manifest['runtime-version']}")
              
          except Exception as e:
              print(f'âŒ Error validating manifest: {e}')
              sys.exit(1)
          PYEOF

      - name: Prepare build environment
        run: |
          mkdir -p build
          mkdir -p flatpak-repo
          echo "Build directory prepared"

      - name: Build Flatpak
        run: |
          flatpak-builder \
            --repo=flatpak-repo \
            --force-clean \
            build-dir \
            io.github.steamdeck_galgame.json

      - name: Create Flatpak bundle
        run: |
          flatpak build-bundle \
            flatpak-repo \
            io.github.steamdeck_galgame.flatpak \
            io.github.steamdeck_galgame

      - name: Generate metadata
        run: |
          python3 << 'PYEOF'
          import json
          import os
          from pathlib import Path
          
          # Read manifest
          with open('io.github.steamdeck_galgame.json') as f:
              manifest = json.load(f)
          
          # Get file info
          flatpak_file = Path('io.github.steamdeck_galgame.flatpak')
          size_mb = flatpak_file.stat().st_size / (1024 * 1024)
          
          # Create metadata
          metadata = {
              'app_id': manifest['app-id'],
              'version': manifest.get('metadata', {}).get('version', 'unknown'),
              'runtime': manifest['runtime'],
              'runtime_version': manifest['runtime-version'],
              'file_size_mb': round(size_mb, 2),
              'build_timestamp': os.popen('date -u +%Y-%m-%dT%H:%M:%SZ').read().strip()
          }
          
          with open('build-metadata.json', 'w') as f:
              json.dump(metadata, f, indent=2)
          
          print('Build metadata:')
          print(json.dumps(metadata, indent=2))
          PYEOF

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-bundle
          path: |
            io.github.steamdeck_galgame.flatpak
            build-metadata.json
          retention-days: 30

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            io.github.steamdeck_galgame.flatpak
            build-metadata.json
          body: |
            # Flatpak Build Release
            
            **Flatpak App ID:** `io.github.steamdeck_galgame`
            
            ## Installation
            
            ```bash
            # Install from bundle (offline)
            flatpak install io.github.steamdeck_galgame.flatpak
            
            # Or add to Flathub first (online)
            flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
            flatpak install flathub io.github.steamdeck_galgame
            ```
            
            ## Run
            
            ```bash
            flatpak run io.github.steamdeck_galgame
            ```
          draft: false
          prerelease: ${{ contains(github.ref, 'rc') || contains(github.ref, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build status summary
        if: always()
        run: |
          echo "## Flatpak Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f io.github.steamdeck_galgame.flatpak ]; then
            echo "âœ… **Build Status:** Success" >> $GITHUB_STEP_SUMMARY
            size=$(ls -lh io.github.steamdeck_galgame.flatpak | awk '{print $5}')
            echo "ðŸ“¦ **Package Size:** $size" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **App ID:** io.github.steamdeck_galgame" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build Status:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Flatpak Bundle: Available for download" >> $GITHUB_STEP_SUMMARY
          echo "- Build Metadata: Available for download" >> $GITHUB_STEP_SUMMARY
