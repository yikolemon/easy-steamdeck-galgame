version: 1

AppDir:
  path: ./AppDir

  app_info:
    id: io.github.steamdeck_galgame
    name: SteamDeck GAL Config
    icon: io.github.steamdeck_galgame
    version: 1.0.0
    exec: bin/python3
    exec_args: $APPDIR/app/run.py --tui
    categories:
      - Utility
      - Game

  runtime:
    enabled: true
    version: continuous

  apt:
    arch: amd64
    sources:
      - sourceline: deb http://archive.ubuntu.com/ubuntu/ focal main universe
      - sourceline: deb http://archive.ubuntu.com/ubuntu/ focal-updates main universe

    packages:
      - python3.7
      - python3-pip
      - libpython3.7-stdlib
      - libpython3.7-minimal

  files:
    # 应用文件
    include:
      - ./src:/app/src
      - ./run.py:/app/run.py
      - ./data:/app/data
      - ./requirements.txt:/app/requirements.txt

    # 排除不需要的文件
    exclude:
      - /usr/share/doc
      - /usr/share/man
      - /usr/share/locale
      - /usr/share/info
      - /usr/share/lintian
      - /usr/share/icons/gnome
      - /usr/share/app-install
      - /usr/share/applications
      - /usr/share/pixmaps
      - /usr/lib/python3*/lib2to3
      - /usr/lib/python3*/distutils
      - /usr/lib/python3*/pydoc_data
      - /usr/lib/python3*/__phello__.foo.pyc

  desktop:
    # 使用现有的 .desktop 模板
    file_name: io.github.steamdeck_galgame.desktop

  icon:
    file_name: io.github.steamdeck_galgame.svg

  # 自定义脚本
  before_bundle: []
  after_bundle:
    - bash -c "mkdir -p AppDir/app"
    - bash -c "cp -r src AppDir/app/"
    - bash -c "cp run.py AppDir/app/"
    - bash -c "cp requirements.txt AppDir/app/"
    - bash -c "cp -r data AppDir/app/"
    - bash -c "mkdir -p AppDir/app/venv && python3.7 -m venv AppDir/app/venv"
    - bash -c "AppDir/app/venv/bin/pip install --upgrade pip setuptools wheel"
    - bash -c "AppDir/app/venv/bin/pip install -r AppDir/app/requirements.txt"

  # 入口点脚本
  create_apprun_script: |
    #!/bin/bash
    set -e
    
    # 获取 AppDir 路径
    APPDIR="$(cd "$(dirname "$0")" && pwd)"
    
    # 设置环境变量
    export LD_LIBRARY_PATH="${APPDIR}/lib:${LD_LIBRARY_PATH}"
    export PATH="${APPDIR}/bin:${PATH}"
    export PYTHONHOME="${APPDIR}/app/venv"
    export PYTHONPATH="${APPDIR}/app:${PYTHONPATH}"
    
    # 运行应用
    exec "${APPDIR}/app/venv/bin/python3" "${APPDIR}/app/run.py" --tui "$@"

AppImage:
  arch: x86_64
  file_name: steamdeck-galgame-1.0.0-x86_64.AppImage
  update-information: gh-releases-zsync|yikolemon|steamdeck-galgame|latest|steamdeck-galgame-*-x86_64.AppImage.zsync
  sign-key: None
  downstream_update_information: None
